<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRESCO Inelastic Scattering Generator</title>
    <meta name="description" content="Generate input files for FRESCO inelastic calculations. Configure parameters for nuclear reaction simulations.">
    <meta name="keywords" content="FRESCO, inelastic, nuclear physics, reaction calculations">
    <meta name="author" content="Jin Lei">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="assets/css/fresco-styles.css">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J60NE88WR1"></script>
    <script src="assets/js/fresco-namelist.js"></script>
    <script src="assets/js/fresco-parameter-manager.js"></script>
    <script src="assets/js/fresco-integration.js"></script>
</head>
<body>
    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark mode">
        <i class="fas fa-moon" id="theme-icon"></i>
    </button>
    
    <a href="index.html" class="home-link">
        <i class="fas fa-home me-2"></i>Home
    </a>

    <!-- Header Section -->
    <header class="header">
        <div class="container">
            <h1><i class="fas fa-atom me-2"></i>Inelastic Scattering</h1>
            <p>Generate FRESCO input files for inelastic scattering calculations</p>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container my-4">
        <!-- Upload Section -->
        <div class="glass-card mb-4">
            <h3><i class="fas fa-upload me-2"></i>Upload Existing Input File</h3>
            <div class="row">
                <div class="col-md-6">
                    <label for="file-upload-inelastic" class="form-label">
                        Select FRESCO Input File
                        <span class="custom-tooltip">
                            <i class="fas fa-info-circle ms-1"></i>
                            <span class="tooltip-text">Upload an existing FRESCO input file (.in, .inp, .txt) to populate the form fields automatically.</span>
                        </span>
                    </label>
                    <input type="file" class="form-control" id="file-upload-inelastic" accept=".in,.inp,.txt" onchange="handleFileUpload(event, 'inelastic')">
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <button type="button" class="glass-btn" onclick="document.getElementById('file-upload-inelastic').click()">
                        <i class="fas fa-folder-open me-2"></i>Browse Files
                    </button>
                </div>
            </div>
            <small class="form-text">Supported formats: .in, .inp, .txt</small>
        </div>

        <form id="inelastic-form">
            <!-- General Parameters -->
            <div class="glass-card">
                <h3><i class="fas fa-cogs me-2"></i>General FRESCO Parameters</h3>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="header" class="form-label">
                            Header
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">Description of the calculation that will appear at the top of the input file.</span>
                            </span>
                        </label>
                        <input type="text" class="form-control" id="header" placeholder="alpha+C12 inelastic scattering">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="hcm" class="form-label">
                            Integration step size (hcm)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">Step size for integration in center-of-mass frame. Smaller values give more accurate results but slower calculations (typical: 0.05-0.1).</span>
                            </span>
                        </label>
                        <input type="number" class="form-control" id="hcm" value="0.05" step="0.01">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="rmatch" class="form-label">
                            Matching radius (rmatch)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">The radius at which the internal and asymptotic solutions are matched (typical: 20-60 fm).</span>
                            </span>
                        </label>
                        <input type="number" class="form-control" id="rmatch" value="20">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="rintp" class="form-label">
                            Integration mesh size (rintp)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">Radial integration mesh size in fm. Typical values are 0.1-0.5 fm.</span>
                            </span>
                        </label>
                        <input type="number" class="form-control" id="rintp" step="0.1">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="rasym" class="form-label">
                            Asymptotic radius (rasym)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">Radius for asymptotic matching (typically 0.0 for automatic).</span>
                            </span>
                        </label>
                        <input type="number" class="form-control" id="rasym" value="0.0" step="0.1">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="jtmin" class="form-label">
                            Min angular momentum (jtmin)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">Minimum angular momentum included in the calculation (typically 0.0).</span>
                            </span>
                        </label>
                        <input type="number" class="form-control" id="jtmin" value="0.0" step="0.5">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="jtmax" class="form-label">
                            Max angular momentum (jtmax)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">Maximum angular momentum included in the calculation. Higher values needed for higher energies and heavier systems.</span>
                            </span>
                        </label>
                        <input type="number" class="form-control" id="jtmax" value="40">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="jbord" class="form-label">
                            J-border (jbord)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">Angular momentum border for coupled channels (usually 0).</span>
                            </span>
                        </label>
                        <input type="number" class="form-control" id="jbord" value="0" step="0.5">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="absend" class="form-label">
                            Convergence parameter (absend)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">Convergence criterion. Smaller values give more precise results (typical: 0.001-0.01).</span>
                            </span>
                        </label>
                        <input type="number" class="form-control" id="absend" value="0.01" step="0.001">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="accrcy" class="form-label">
                            Accuracy (accrcy)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">Numerical accuracy parameter (typically 0.0001).</span>
                            </span>
                        </label>
                        <input type="number" class="form-control" id="accrcy" value="0.0001" step="0.0001">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="thmin" class="form-label">
                            Minimum angle (thmin)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">Minimum scattering angle in degrees (usually 0.0).</span>
                            </span>
                        </label>
                        <input type="number" class="form-control" id="thmin" value="0.0" step="0.1">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="thmax" class="form-label">
                            Maximum angle (thmax)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">Maximum scattering angle in degrees.</span>
                            </span>
                        </label>
                        <input type="number" class="form-control" id="thmax" value="180">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="thinc" class="form-label">
                            Angle increment (thinc)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">Increment between calculated scattering angles in degrees.</span>
                            </span>
                        </label>
                        <input type="number" class="form-control" id="thinc" value="1.0" step="0.1">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="xstabl" class="form-label">
                            Cross-section units (xstabl)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">Cross-section units: 1 for mb, 2 for fm².</span>
                            </span>
                        </label>
                        <select class="form-select" id="xstabl">
                            <option value="1">1 - Millibarns (mb)</option>
                            <option value="2">2 - Square femtometers (fm²)</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="elab" class="form-label">
                            Laboratory energy (elab)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">Laboratory energy of the projectile in MeV. For multi-energy calculations, use comma-separated values.</span>
                            </span>
                        </label>
                        <input type="text" class="form-control" id="elab" value="100.0">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="iter" class="form-label">
                            Number of iterations (iter)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">Number of iterations for solving coupled equations. For inelastic scattering, a value of 1 is usually sufficient.</span>
                            </span>
                        </label>
                        <input type="number" class="form-control" id="iter" value="1" min="1">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="iblock" class="form-label">
                            Blocked channels (iblock)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">Number of channels to block together and solve exactly. For inelastic calculations, this should be set to the number of excited states plus one.</span>
                            </span>
                        </label>
                        <input type="number" class="form-control" id="iblock" value="1" min="1">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="chans" class="form-label">
                            Channels output (chans)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">Channel output control (typically 1).</span>
                            </span>
                        </label>
                        <input type="number" class="form-control" id="chans" value="1">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="smats" class="form-label">
                            S-matrix output (smats)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">S-matrix output control (typically 2).</span>
                            </span>
                        </label>
                        <input type="number" class="form-control" id="smats" value="2">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="switch" class="form-label">
                            Switch parameter (switch)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">Switch for calculation options (typically 0.0).</span>
                            </span>
                        </label>
                        <input type="number" class="form-control" id="switch" value="0.0" step="0.1">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="ajswtch" class="form-label">
                            Angular momentum switch (ajswtch)
                            <span class="custom-tooltip">
                                <i class="fas fa-info-circle ms-1"></i>
                                <span class="tooltip-text">Angular momentum switch parameter (typically 0.0).</span>
                            </span>
                        </label>
                        <input type="number" class="form-control" id="ajswtch" value="0.0" step="0.5">
                    </div>
                </div>
            </div>

            <!-- Advanced FRESCO Namelist Parameters -->
            <div class="glass-card advanced-fresco-card">
                <h3><i class="fas fa-sliders-h me-2"></i>Advanced FRESCO Parameters</h3>
                <p class="text-white-50 mb-3">Configure additional namelist parameters. Only non-default values will be included in the generated input file.</p>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <button type="button" class="glass-btn" onclick="toggleNamelistSection('radialCoordinates')">
                            <i class="fas fa-ruler me-2"></i>Radial Coordinates
                        </button>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button type="button" class="glass-btn" onclick="toggleNamelistSection('partialWaves')">
                            <i class="fas fa-wave-square me-2"></i>Partial Waves
                        </button>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button type="button" class="glass-btn" onclick="toggleNamelistSection('angularDistributions')">
                            <i class="fas fa-chart-line me-2"></i>Angular Distributions
                        </button>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button type="button" class="glass-btn" onclick="toggleNamelistSection('coupledEquations')">
                            <i class="fas fa-link me-2"></i>Coupled Equations
                        </button>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button type="button" class="glass-btn" onclick="toggleNamelistSection('incidentChannel')">
                            <i class="fas fa-arrow-right me-2"></i>Incident Channel
                        </button>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button type="button" class="glass-btn" onclick="toggleNamelistSection('solvingEquations')">
                            <i class="fas fa-calculator me-2"></i>Solving Equations
                        </button>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button type="button" class="glass-btn" onclick="toggleNamelistSection('traceVariables')">
                            <i class="fas fa-bug me-2"></i>Trace Variables
                        </button>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button type="button" class="glass-btn" onclick="toggleNamelistSection('outputDetails')">
                            <i class="fas fa-file-export me-2"></i>Output Details
                        </button>
                    </div>
                </div>
                <div id="namelist-forms" class="mt-3"></div>
            </div>

            <!-- Partition Parameters -->
            <div class="glass-card">
                <h3><i class="fas fa-project-diagram me-2"></i>Partition Parameters</h3>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h4 class="mb-3">Projectile</h4>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="projectile" class="form-label">
                                    Symbol
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Symbol of the projectile nucleus (e.g., alpha, p, d, etc.).</span>
                                    </span>
                                </label>
                                <input type="text" class="form-control" id="projectile" value="alpha">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="proj-mass" class="form-label">
                                    Mass (amu)
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Mass of projectile in atomic mass units.</span>
                                    </span>
                                </label>
                                <input type="number" class="form-control" id="proj-mass" value="4.00" step="0.01">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="proj-z" class="form-label">
                                    Charge (Z)
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Atomic number of the projectile.</span>
                                    </span>
                                </label>
                                <input type="number" class="form-control" id="proj-z" value="2">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="proj-excited" class="form-label">
                                    Number of excited states
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Number of excited states to include for projectile (including ground state).</span>
                                    </span>
                                </label>
                                <input type="number" class="form-control" id="proj-excited" value="1" min="1">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="proj-spin" class="form-label">
                                    Default spin (jp)
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Default spin of projectile states.</span>
                                    </span>
                                </label>
                                <input type="number" class="form-control" id="proj-spin" value="0.0" step="0.5">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="ptyp" class="form-label">
                                    Projectile type (ptyp)
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Projectile type parameter.</span>
                                    </span>
                                </label>
                                <input type="number" class="form-control" id="ptyp" value="0">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="proj-energy" class="form-label">
                                    Default energy (ep)
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Default excitation energy for projectile.</span>
                                    </span>
                                </label>
                                <input type="number" class="form-control" id="proj-energy" value="0.0" step="0.01">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h4 class="mb-3">Target</h4>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="target" class="form-label">
                                    Symbol
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Symbol of the target nucleus.</span>
                                    </span>
                                </label>
                                <input type="text" class="form-control" id="target" value="12C">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="targ-mass" class="form-label">
                                    Mass (amu)
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Mass of target in atomic mass units.</span>
                                    </span>
                                </label>
                                <input type="number" class="form-control" id="targ-mass" value="12.0" step="0.1">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="targ-z" class="form-label">
                                    Charge (Z)
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Atomic number of the target.</span>
                                    </span>
                                </label>
                                <input type="number" class="form-control" id="targ-z" value="6">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="targ-excited" class="form-label">
                                    Number of excited states (nex)
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Number of excited states to include for target (including ground state).</span>
                                    </span>
                                </label>
                                <input type="number" class="form-control" id="targ-excited" value="2" min="1">
                                <input type="hidden" class="form-control" id="nex" value="2">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="targ-spin" class="form-label">
                                    Default spin (jt)
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Default spin of target states.</span>
                                    </span>
                                </label>
                                <input type="number" class="form-control" id="targ-spin" value="0.0" step="0.5">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="ptyt" class="form-label">
                                    Target type (ptyt)
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Target type parameter.</span>
                                    </span>
                                </label>
                                <input type="number" class="form-control" id="ptyt" value="0">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="targ-energy" class="form-label">
                                    Default energy (et)
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Default excitation energy for target.</span>
                                    </span>
                                </label>
                                <input type="number" class="form-control" id="targ-energy" value="0.0" step="0.01">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="qval" class="form-label">
                                    Q-value (qval)
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Q-value for the reaction in MeV. Usually 0.0 for inelastic scattering.</span>
                                    </span>
                                </label>
                                <input type="number" class="form-control" id="qval" value="0.0" step="0.01">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cpot" class="form-label">
                                    Copy potential (cpot)
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Copy potential from partition (usually 1).</span>
                                    </span>
                                </label>
                                <input type="number" class="form-control" id="cpot" value="1">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="copyt" class="form-label">
                                    Copy target (copyt)
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Copy target parameter.</span>
                                    </span>
                                </label>
                                <input type="number" class="form-control" id="copyt" value="1">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Excited States Section -->
            <div class="glass-card">
                <h3><i class="fas fa-arrow-up me-2"></i>Excited States</h3>
                
                <!-- Target Excited States Section -->
                <h4 class="mb-3">Target Excited States</h4>
                <div id="target-states-container">
                    <!-- Ground state is always included -->
                    <div class="excited-state-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Ground State</h5>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">
                                    Spin (J)
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Ground state spin of the target nucleus (in units of ħ).</span>
                                    </span>
                                </label>
                                <input type="number" class="form-control targ-state-spin" value="0.0" step="0.5">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">
                                    Parity
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Parity of the state (+1 for positive, -1 for negative).</span>
                                    </span>
                                </label>
                                <select class="form-select targ-state-parity">
                                    <option value="1">Positive (+1)</option>
                                    <option value="-1">Negative (-1)</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">
                                    Excitation Energy (MeV)
                                    <span class="custom-tooltip">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        <span class="tooltip-text">Energy of excited state relative to ground state. Set to 0 for ground state.</span>
                                    </span>
                                </label>
                                <input type="number" class="form-control targ-state-energy" value="0.0" step="0.01" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Excited states will be added here dynamically -->
                <div id="additional-target-states"></div>
                
                <!-- Add State Button (only shown if more states needed) -->
                <div class="add-state-btn" id="add-target-state-btn">
                    <i class="fas fa-plus me-2"></i>Add Target Excited State
                </div>
                
                <!-- Projectile Excited States Section (if applicable) -->
                <div id="projectile-states-section" class="mt-4">
                    <h4 class="mb-3">Projectile Excited States</h4>
                    <div id="projectile-states-container">
                        <!-- Ground state is always included -->
                        <div class="excited-state-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>Ground State</h5>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">
                                        Spin (J)
                                        <span class="custom-tooltip">
                                            <i class="fas fa-info-circle ms-1"></i>
                                            <span class="tooltip-text">Ground state spin of the projectile nucleus (in units of ħ).</span>
                                        </span>
                                    </label>
                                    <input type="number" class="form-control proj-state-spin" value="0.0" step="0.5">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">
                                        Parity
                                        <span class="custom-tooltip">
                                            <i class="fas fa-info-circle ms-1"></i>
                                            <span class="tooltip-text">Parity of the state (+1 for positive, -1 for negative).</span>
                                        </span>
                                    </label>
                                    <select class="form-select proj-state-parity">
                                        <option value="1">Positive (+1)</option>
                                        <option value="-1">Negative (-1)</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">
                                        Excitation Energy (MeV)
                                        <span class="custom-tooltip">
                                            <i class="fas fa-info-circle ms-1"></i>
                                            <span class="tooltip-text">Energy of excited state relative to ground state. Set to 0 for ground state.</span>
                                        </span>
                                    </label>
                                    <input type="number" class="form-control proj-state-energy" value="0.0" step="0.01" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional projectile excited states will be added here -->
                    <div id="additional-proj-states"></div>
                    
                    <!-- Add Projectile State Button (only shown if more states needed) -->
                    <div class="add-state-btn" id="add-proj-state-btn">
                        <i class="fas fa-plus me-2"></i>Add Projectile Excited State
                    </div>
                </div>
            </div>

            <!-- Potentials Section -->
            <div class="glass-card">
                <h3><i class="fas fa-atom me-2"></i>Potential Parameters</h3>
                
                <!-- Comprehensive Potential Documentation -->
                <div class="alert alert-info">
                    <h5><i class="fas fa-info-circle me-2"></i>Nuclear Potential Form Factor Information</h5>
                    <p><strong>Note:</strong> TYPE=0 (Coulomb potential) is handled separately in the Coulomb potential section above. The nuclear potential options below are for TYPE=1 and higher.</p>
                    <p><strong>Shape Definitions:</strong></p>
                    <ul class="mb-2">
                        <li><strong>Volume potentials (TYPE=1,8,15):</strong> R = P2*CC, RH = (r-R)/P3, E = exp(-(r-R)/P3)</li>
                        <li><strong>Surface potentials (TYPE=2):</strong> First derivative forms, normalized to -1 when E=1</li>
                        <li><strong>Spin-orbit potentials (TYPE=3,4):</strong> Multiplied by [j(j+1)-l(l+1)-s(s+1)]/2l·s, CONLS = 2.000</li>
                        <li><strong>Tensor potentials (TYPE=5,6,7):</strong> Second derivative forms, normalized to unity when E=1</li>
                    </ul>
                    <p><strong>Special Features:</strong></p>
                    <ul class="mb-0">
                        <li>If TYPE < 0: Add potential numerically to previous potential using abs(TYPE)</li>
                        <li>SHAPE ≥ 30: L/J-dependent potential with form factor</li>
                        <li>SHAPE = 40-42: Parity/L/J-dependent potentials</li>
                        <li>SHAPE 7-9: Read from external file (rewind with negative values)</li>
                    </ul>
                </div>
                
                <!-- Coulomb Potential -->
                <div class="potential-card" id="coulomb-potential">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Coulomb Potential</h4>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="rc" class="form-label">
                                Coulomb radius (rc)
                                <span class="custom-tooltip">
                                    <i class="fas fa-info-circle ms-1"></i>
                                    <span class="tooltip-text">Coulomb radius parameter in fm. Typically 1.2-1.3 times A^(1/3).</span>
                                </span>
                            </label>
                            <input type="number" class="form-control" id="rc" value="1.2" step="0.1">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="ap" class="form-label">
                                Projectile mass number (ap)
                                <span class="custom-tooltip">
                                    <i class="fas fa-info-circle ms-1"></i>
                                    <span class="tooltip-text">Mass number of the projectile used for Coulomb potential calculation.</span>
                                </span>
                            </label>
                            <input type="number" class="form-control" id="ap" value="4.0" step="0.1">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="at" class="form-label">
                                Target mass number (at)
                                <span class="custom-tooltip">
                                    <i class="fas fa-info-circle ms-1"></i>
                                    <span class="tooltip-text">Mass number of the target used for Coulomb potential calculation.</span>
                                </span>
                            </label>
                            <input type="number" class="form-control" id="at" value="12.0" step="0.1">
                        </div>
                    </div>
                </div>
                
                <!-- Nuclear Potentials -->
                <div id="potential-container">
                    <!-- This will be filled with potential cards -->
                </div>
                
                <!-- Add Potential Button -->
                <div class="add-potential-btn" id="add-potential-btn">
                    <i class="fas fa-plus me-2"></i>Add Nuclear Potential
                </div>
                
                <!-- Deformation Parameters -->
                <div class="potential-card" id="deformation-parameters">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Deformation Parameters</h4>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="def-type" class="form-label">
                                Deformation Type
                                <span class="custom-tooltip">
                                    <i class="fas fa-info-circle ms-1"></i>
                                    <span class="tooltip-text">Type of deformation to include.</span>
                                </span>
                            </label>
                            <select class="form-select" id="def-type">
                                <option value="11">Deformed Target (TYPE=11)</option>
                                <option value="10">Deformed Projectile (TYPE=10)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="def-shape" class="form-label">
                                Deformation Method
                                <span class="custom-tooltip">
                                    <i class="fas fa-info-circle ms-1"></i>
                                    <span class="tooltip-text">Method for calculating deformation: 10 for first-order approximation, 11 for numerical deformation.</span>
                                </span>
                            </label>
                            <select class="form-select" id="def-shape">
                                <option value="10">First order (SHAPE=10)</option>
                                <option value="11">Numerical (SHAPE=11)</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="beta2" class="form-label">
                                β₂ Parameter
                                <span class="custom-tooltip">
                                    <i class="fas fa-info-circle ms-1"></i>
                                    <span class="tooltip-text">Quadrupole deformation parameter (β₂).</span>
                                </span>
                            </label>
                            <input type="number" class="form-control" id="beta2" value="0.608" step="0.001">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="beta3" class="form-label">
                                β₃ Parameter
                                <span class="custom-tooltip">
                                    <i class="fas fa-info-circle ms-1"></i>
                                    <span class="tooltip-text">Octupole deformation parameter (β₃). Typically needed for negative parity states.</span>
                                </span>
                            </label>
                            <input type="number" class="form-control" id="beta3" value="0.0" step="0.001">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Generate Button -->
            <div class="text-center mt-4">
                <button type="button" id="generate-btn" class="btn btn-primary btn-lg">
                    <i class="fas fa-file-code me-2"></i>Generate Input File
                </button>
            </div>
        </form>

        <!-- Output Section -->
        <div class="glass-card mt-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0"><i class="fas fa-code me-2"></i>Generated Input File</h3>
                <div>
                    <button id="copy-btn" class="action-btn me-2">
                        <i class="fas fa-copy me-1"></i>Copy
                    </button>
                    <button id="download-btn" class="action-btn">
                        <i class="fas fa-download me-1"></i>Download
                    </button>
                </div>
            </div>
            <pre id="output" class="output-area">Select parameters and click "Generate Input File" to create a FRESCO input file for inelastic scattering.</pre>
        </div>
    </div>

    <!-- Footer Section -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>FRESCO Input Generator</h5>
                    <p>A user-friendly web tool for generating input files for the FRESCO nuclear reaction code. </p>
                    <p>Designed and made by <a href="http://jinlei.fewbody.com/">Jin Lei</a>. Supported by the National Natural Science Foundation of China (Grants No. 12475132). If you find any bugs or errors related to this website, please <a href="mailto:jinl@tongji.edu.cn">email me</a>.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <h5>Resources</h5>
                    <ul class="list-unstyled">
                        <li><a href="fresco.pdf" target="_blank">FRESCO Documentation</a></li>
                        <li><a href="https://github.com/I-Thompson/fresco" target="_blank">FRESCO GitHub Repository</a></li>
                    </ul>
                </div>
            </div>
            <hr class="my-4" style="border-color: rgba(255, 255, 255, 0.1);">
            <div class="text-center">
                <p class="mb-0">© 2025 FRESCO Input Generator. Created for educational and research purposes. Designed and made by <a href="http://jinlei.fewbody.com/">Jin Lei</a>.</p>
            </div>
        </div>
    </footer>

    <!-- Potential Template -->
    <template id="potential-template">
        <div class="potential-card" data-potential-id="">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Nuclear Potential <span class="potential-number"></span></h4>
                <a href="#" class="remove-potential"><i class="fas fa-times"></i></a>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="potential-type" class="form-label">
                        Potential Type
                        <span class="custom-tooltip">
                            <i class="fas fa-info-circle ms-1"></i>
                            <span class="tooltip-text">Type of nuclear potential.</span>
                        </span>
                    </label>
                    <select class="form-select potential-type">
                        <option value="1" selected>1 - Central potential, Volume</option>
                        <option value="2">2 - Central potential, Derivative (surface)</option>
                        <option value="3">3 - Spin-orbit for projectile</option>
                        <option value="4">4 - Spin-orbit for target</option>
                        <option value="5">5 - Tr tensor force for projectile</option>
                        <option value="6">6 - Tr tensor force for target</option>
                        <option value="7">7 - Tensor force between L and combined spins</option>
                        <option value="8">8 - Nucleon-nucleon SSC potential</option>
                        <option value="9">9 - User-supplied nucleon-nucleon potential</option>
                        <option value="10">10 - Deformed projectile (matrix elements from ROTOR)</option>
                        <option value="11">11 - Deformed target (matrix elements from ROTOR)</option>
                        <option value="12">12 - Projectile coupled by matrix elements read in</option>
                        <option value="13">13 - Target coupled by matrix elements read in</option>
                        <option value="14">14 - Projectile second-order coupled by matrix elements</option>
                        <option value="15">15 - Central potential, Volume (for TYPE 15)</option>
                        <option value="16">16 - Target & projectile simultaneous second-order coupled</option>
                        <option value="17">17 - Target & projectile all-order coupled</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="potential-shape" class="form-label">
                        Shape
                        <span class="custom-tooltip">
                            <i class="fas fa-info-circle ms-1"></i>
                            <span class="tooltip-text">Radial shape of the potential.</span>
                        </span>
                    </label>
                    <select class="form-select potential-shape">
                        <option value="0" selected>0 - Woods-Saxon: -P1/(1+1/E)</option>
                        <option value="1">1 - WS squared: -P1/(1+1/E)²</option>
                        <option value="2">2 - Gaussian: -P1*exp(-RH²)</option>
                        <option value="3">3 - Yukawa: -P1*E/r</option>
                        <option value="4">4 - Exponential: -P1*E</option>
                        <option value="5">5 - Reid soft core T=0, central part</option>
                        <option value="6">6 - Reid soft core T=1, central part</option>
                        <option value="7">7 - Read Real from file</option>
                        <option value="8">8 - Read Imaginary from file</option>
                        <option value="9">9 - Read Complex from file</option>
                        <option value="-1">-1 - Fourier-Bessel: j₀(RH) = sin(RH)/RH</option>
                        <option value="-7">-7 - Rewind and read Real from file</option>
                        <option value="-8">-8 - Rewind and read Imaginary from file</option>
                        <option value="-9">-9 - Rewind and read Complex from file</option>
                        <option value="10">10 - Write potential to Output file 25</option>
                        <option value="20">20 - J-dependent potential from file</option>
                        <option value="21">21 - J-dependent potential from file</option>
                        <option value="22">22 - J-dependent potential from file</option>
                        <option value="23">23 - J-dependent potential from file</option>
                        <option value="24">24 - J-dependent potential from file</option>
                        <option value="30">30 - L/J-dependent form factor</option>
                        <option value="40">40 - Parity-dependent: P1 for +, P2 for -</option>
                        <option value="41">41 - L-dependent: P(L+1) for L=0-5</option>
                        <option value="42">42 - J-dependent: P(Ji+1) for Ji=0-5</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="kp-field" class="form-label">
                        Potential set (kp)
                        <span class="custom-tooltip">
                            <i class="fas fa-info-circle ms-1"></i>
                            <span class="tooltip-text">Potential set number (usually 1).</span>
                        </span>
                    </label>
                    <input type="number" class="form-control kp-field" value="1" min="1">
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="it-field" class="form-label">
                        IT Parameter
                        <span class="custom-tooltip">
                            <i class="fas fa-info-circle ms-1"></i>
                            <span class="tooltip-text">1 or 3: include only iteratively; 2 or 3: do NOT subtract in KIND=3,4 single-particle couplings</span>
                        </span>
                    </label>
                    <select class="form-select it-field">
                        <option value="1" selected>1 - Include iteratively only</option>
                        <option value="2">2 - Do not subtract in KIND=3,4</option>
                        <option value="3">3 - Both: iterative & no subtract</option>
                    </select>
                </div>
            </div>
            <div class="row real-params">
                <div class="col-md-12 mb-2">
                    <h5>Real Part</h5>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                        Depth (p1)
                        <span class="custom-tooltip">
                            <i class="fas fa-info-circle ms-1"></i>
                            <span class="tooltip-text">Depth of the real part of the potential in MeV.</span>
                        </span>
                    </label>
                    <input type="number" class="form-control p1" value="40.0" step="0.1">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                        Radius (p2)
                        <span class="custom-tooltip">
                            <i class="fas fa-info-circle ms-1"></i>
                            <span class="tooltip-text">Radius parameter for the potential in fm.</span>
                        </span>
                    </label>
                    <input type="number" class="form-control p2" value="1.2" step="0.1">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                        Diffuseness (p3)
                        <span class="custom-tooltip">
                            <i class="fas fa-info-circle ms-1"></i>
                            <span class="tooltip-text">Diffuseness parameter for the potential in fm.</span>
                        </span>
                    </label>
                    <input type="number" class="form-control p3" value="0.65" step="0.01">
                </div>
            </div>
            <div class="row imag-params">
                <div class="col-md-12 mb-2">
                    <h5>Imaginary Part</h5>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                        Depth (p4)
                        <span class="custom-tooltip">
                            <i class="fas fa-info-circle ms-1"></i>
                            <span class="tooltip-text">Depth of the imaginary part of the potential in MeV.</span>
                        </span>
                    </label>
                    <input type="number" class="form-control p4" value="10.0" step="0.1">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                        Radius (p5)
                        <span class="custom-tooltip">
                            <i class="fas fa-info-circle ms-1"></i>
                            <span class="tooltip-text">Radius parameter for the imaginary potential in fm.</span>
                        </span>
                    </label>
                    <input type="number" class="form-control p5" value="1.2" step="0.1">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                        Diffuseness (p6)
                        <span class="custom-tooltip">
                            <i class="fas fa-info-circle ms-1"></i>
                            <span class="tooltip-text">Diffuseness parameter for the imaginary potential in fm.</span>
                        </span>
                    </label>
                    <input type="number" class="form-control p6" value="0.5" step="0.01">
                </div>
            </div>
            <div class="row additional-params">
                <div class="col-md-12 mb-2">
                    <h5>Additional Parameters</h5>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">
                        P0 Parameter
                        <span class="custom-tooltip">
                            <i class="fas fa-info-circle ms-1"></i>
                            <span class="tooltip-text">Additional parameter P0. Used for L≥6 in L-dependent potentials (SHAPE=41) or Ji≥6 in J-dependent potentials (SHAPE=42).</span>
                        </span>
                    </label>
                    <input type="number" class="form-control p0" value="0.0" step="0.01">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">
                        P7 Parameter
                        <span class="custom-tooltip">
                            <i class="fas fa-info-circle ms-1"></i>
                            <span class="tooltip-text">Further parameter P7 for specialized potential forms.</span>
                        </span>
                    </label>
                    <input type="number" class="form-control p7" value="0.0" step="0.01">
                </div>
            </div>
        </div>
    </template>

    <!-- Target Excited State Template -->
    <template id="target-state-template">
        <div class="excited-state-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Excited State <span class="state-number"></span></h5>
                <a href="#" class="remove-state"><i class="fas fa-times"></i></a>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                        Spin (J)
                        <span class="custom-tooltip">
                            <i class="fas fa-info-circle ms-1"></i>
                            <span class="tooltip-text">Spin of the excited state (in units of ħ).</span>
                        </span>
                    </label>
                    <input type="number" class="form-control targ-state-spin" value="2.0" step="0.5">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                        Parity
                        <span class="custom-tooltip">
                            <i class="fas fa-info-circle ms-1"></i>
                            <span class="tooltip-text">Parity of the state (+1 for positive, -1 for negative).</span>
                        </span>
                    </label>
                    <select class="form-select targ-state-parity">
                        <option value="1">Positive (+1)</option>
                        <option value="-1">Negative (-1)</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                        Excitation Energy (MeV)
                        <span class="custom-tooltip">
                            <i class="fas fa-info-circle ms-1"></i>
                            <span class="tooltip-text">Energy of excited state relative to ground state.</span>
                        </span>
                    </label>
                    <input type="number" class="form-control targ-state-energy" value="4.43" step="0.01">
                </div>
            </div>
        </div>
    </template>

    <!-- Projectile Excited State Template -->
    <template id="proj-state-template">
        <div class="excited-state-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Excited State <span class="state-number"></span></h5>
                <a href="#" class="remove-state"><i class="fas fa-times"></i></a>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                        Spin (J)
                        <span class="custom-tooltip">
                            <i class="fas fa-info-circle ms-1"></i>
                            <span class="tooltip-text">Spin of the excited state (in units of ħ).</span>
                        </span>
                    </label>
                    <input type="number" class="form-control proj-state-spin" value="2.0" step="0.5">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                        Parity
                        <span class="custom-tooltip">
                            <i class="fas fa-info-circle ms-1"></i>
                            <span class="tooltip-text">Parity of the state (+1 for positive, -1 for negative).</span>
                        </span>
                    </label>
                    <select class="form-select proj-state-parity">
                        <option value="1">Positive (+1)</option>
                        <option value="-1">Negative (-1)</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                        Excitation Energy (MeV)
                        <span class="custom-tooltip">
                            <i class="fas fa-info-circle ms-1"></i>
                            <span class="tooltip-text">Energy of excited state relative to ground state.</span>
                        </span>
                    </label>
                    <input type="number" class="form-control proj-state-energy" value="0.0" step="0.01">
                </div>
            </div>
        </div>
    </template>

    <!-- JavaScript Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="assets/js/fresco-common.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if FrescoNamelist is available
            console.log('DOM loaded, checking FrescoNamelist:', typeof window.FrescoNamelist);
            
            // Initialize basic form fields with configuration values
            if (window.FrescoNamelist && window.FrescoNamelist.initializeBasicFields) {
                window.FrescoNamelist.initializeBasicFields();
            }
            
            // Advanced namelist section management
            const activeNamelistSections = new Set();
            
            // Toggle namelist section function
            window.toggleNamelistSection = function(sectionName) {
                console.log('Toggle section called:', sectionName);
                console.log('FrescoNamelist available:', typeof window.FrescoNamelist);
                
                const container = document.getElementById('namelist-forms');
                if (!container) {
                    console.error('Container namelist-forms not found');
                    return;
                }
                
                const existingSection = document.getElementById(`namelist-${sectionName}`);
                
                if (existingSection) {
                    // Section exists, remove it
                    existingSection.remove();
                    activeNamelistSections.delete(sectionName);
                    console.log('Section removed:', sectionName);
                } else {
                    // Section doesn't exist, create it
                    const sectionDiv = document.createElement('div');
                    sectionDiv.id = `namelist-${sectionName}`;
                    sectionDiv.className = 'namelist-section mt-3';
                    
                    // Add a simple test content first
                    sectionDiv.innerHTML = `<div class="glass-card"><h4>Loading ${sectionName}...</h4></div>`;
                    
                    // First add the section to the DOM
                    container.appendChild(sectionDiv);
                    console.log('Section div added to DOM');
                    
                    // Then create the form in it
                    if (window.FrescoNamelist && window.FrescoNamelist.createCategoryForm) {
                        console.log('Creating category form...');
                        window.FrescoNamelist.createCategoryForm(sectionName, sectionDiv.id, {});
                    } else {
                        console.error('FrescoNamelist not available or createCategoryForm not found');
                        sectionDiv.innerHTML = '<div class="glass-card"><p class="text-danger">Error: FrescoNamelist configuration not loaded</p></div>';
                    }
                    
                    activeNamelistSections.add(sectionName);
                }
                
                // Update button states
                updateNamelistButtons();
            };
            
            // Update button appearance based on active sections
            function updateNamelistButtons() {
                document.querySelectorAll('[onclick*="toggleNamelistSection"]').forEach(button => {
                    const sectionName = button.getAttribute('onclick').match(/toggleNamelistSection\('([^']+)'\)/)[1];
                    if (activeNamelistSections.has(sectionName)) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                });
            }
            
            // Potential management
            const potentialContainer = document.getElementById('potential-container');
            const addPotentialBtn = document.getElementById('add-potential-btn');
            const potentialTemplate = document.getElementById('potential-template');
            let potentialCount = 0;
            
            // Initialize ap and at fields with the corresponding mass values
            document.getElementById('ap').value = document.getElementById('proj-mass').value;
            document.getElementById('at').value = document.getElementById('targ-mass').value;
            
            // Add event listeners to update ap and at when proj-mass and targ-mass change
            document.getElementById('proj-mass').addEventListener('change', function() {
                document.getElementById('ap').value = this.value;
            });
            
            document.getElementById('targ-mass').addEventListener('change', function() {
                document.getElementById('at').value = this.value;
            });
            
            // Add a nuclear potential
            function addPotential() {
                potentialCount++;
                
                // Clone the template
                const potentialNode = document.importNode(potentialTemplate.content, true);
                
                // Set unique IDs and update labels
                const potentialCard = potentialNode.querySelector('.potential-card');
                potentialCard.dataset.potentialId = potentialCount;
                potentialCard.querySelector('.potential-number').textContent = potentialCount;
                
                // Set remove button action
                potentialCard.querySelector('.remove-potential').addEventListener('click', function(e) {
                    e.preventDefault();
                    potentialCard.remove();
                    updatePotentialNumbers();
                });
                
                // Add potential shape change handler
                const potentialTypeSelect = potentialCard.querySelector('.potential-type');
                potentialTypeSelect.addEventListener('change', function() {
                    updatePotentialParameters(potentialCard, this.value);
                });
                
                // Append to container
                potentialContainer.appendChild(potentialNode);
                
                return potentialCard;
            }
            
            // Update numbering when a potential is removed
            function updatePotentialNumbers() {
                const potentials = potentialContainer.querySelectorAll('.potential-card');
                potentials.forEach((potential, index) => {
                    potential.querySelector('.potential-number').textContent = index + 1;
                    potential.dataset.potentialId = index + 1;
                });
                potentialCount = potentials.length;
            }
            
            // Update parameter fields based on potential type
            function updatePotentialParameters(potentialCard, typeValue) {
                const realParams = potentialCard.querySelector('.real-params');
                const imagParams = potentialCard.querySelector('.imag-params');
                
                // Handle spin-orbit potential
                if (typeValue === '3' || typeValue === '4') {
                    // Update tooltips for spin-orbit potentials
                    potentialCard.querySelector('.p1').closest('.col-md-4').querySelector('.tooltip-text').textContent = 
                        'Strength of the spin-orbit potential (typically 0.5-10 MeV).';
                    potentialCard.querySelector('.p2').closest('.col-md-4').querySelector('.tooltip-text').textContent = 
                        'Radius parameter for the spin-orbit potential in fm.';
                    potentialCard.querySelector('.p3').closest('.col-md-4').querySelector('.tooltip-text').textContent = 
                        'Diffuseness parameter for the spin-orbit potential in fm.';
                }
            }
            
            // Make addPotential globally accessible for file upload
            window.addPotential = addPotential;
            
            // Add initial potential
            const initialPotential = addPotential();
            
            // Add potential button listener
            addPotentialBtn.addEventListener('click', function() {
                addPotential();
            });

            // Target excited states management
            const addTargetStateBtn = document.getElementById('add-target-state-btn');
            const targetStateTemplate = document.getElementById('target-state-template');
            const additionalTargetStates = document.getElementById('additional-target-states');
            let targetStateCount = 1; // Ground state is already included
            
            // Add a target excited state
            function addTargetState() {
                // Clone the template
                const stateNode = document.importNode(targetStateTemplate.content, true);
                
                // Set unique labels
                const stateCard = stateNode.querySelector('.excited-state-card');
                stateCard.querySelector('.state-number').textContent = targetStateCount;
                
                // Set remove button action
                stateCard.querySelector('.remove-state').addEventListener('click', function(e) {
                    e.preventDefault();
                    stateCard.remove();
                    updateTargetStateNumbers();
                    // Update the number of excited states
                    document.getElementById('targ-excited').value = targetStateCount;
                    // Update iblock value
                    updateIblockValue();
                });
                
                // Append to container
                additionalTargetStates.appendChild(stateNode);
                targetStateCount++;
                
                // Update the number of excited states
                document.getElementById('targ-excited').value = targetStateCount;
                
                // Update iblock value
                updateIblockValue();
                
                return stateCard;
            }
            
            // Update numbering when a state is removed
            function updateTargetStateNumbers() {
                const states = additionalTargetStates.querySelectorAll('.excited-state-card');
                states.forEach((state, index) => {
                    state.querySelector('.state-number').textContent = index + 1;
                });
                targetStateCount = states.length + 1; // +1 for ground state
            }
            
            // Add event listener for target excited states number input
            document.getElementById('targ-excited').addEventListener('change', function() {
                const numStates = parseInt(this.value);
                
                // Update the hidden nex field
                document.getElementById('nex').value = numStates;
                
                // Make sure there's at least 1 state (ground state)
                if (numStates < 1) {
                    this.value = 1;
                    document.getElementById('nex').value = 1;
                    return;
                }
                
                // If we need to add more states
                while (targetStateCount < numStates) {
                    addTargetState();
                }
                
                // If we need to remove states
                if (targetStateCount > numStates) {
                    const states = additionalTargetStates.querySelectorAll('.excited-state-card');
                    for (let i = numStates - 1; i < states.length; i++) {
                        states[i].remove();
                    }
                    targetStateCount = numStates;
                    updateTargetStateNumbers();
                }
                
                // Update iblock value
                updateIblockValue();
            });
            
            // Add state button listener
            addTargetStateBtn.addEventListener('click', function() {
                addTargetState();
            });
            
            // Projectile excited states management
            const addProjStateBtn = document.getElementById('add-proj-state-btn');
            const projStateTemplate = document.getElementById('proj-state-template');
            const additionalProjStates = document.getElementById('additional-proj-states');
            let projStateCount = 1; // Ground state is already included

            // Add a projectile excited state
            function addProjectileState() {
                // Clone the template
                const stateNode = document.importNode(projStateTemplate.content, true);
                
                // Set unique labels
                const stateCard = stateNode.querySelector('.excited-state-card');
                stateCard.querySelector('.state-number').textContent = projStateCount;
                
                // Set remove button action
                stateCard.querySelector('.remove-state').addEventListener('click', function(e) {
                    e.preventDefault();
                    stateCard.remove();
                    updateProjStateNumbers();
                    // Update the number of excited states
                    document.getElementById('proj-excited').value = projStateCount;
                    // Update iblock value
                    updateIblockValue();
                });
                
                // Append to container
                additionalProjStates.appendChild(stateNode);
                projStateCount++;
                
                // Update the number of excited states
                document.getElementById('proj-excited').value = projStateCount;
                
                // Update iblock value
                updateIblockValue();
                
                return stateCard;
            }
            
            // Update numbering when a state is removed
            function updateProjStateNumbers() {
                const states = additionalProjStates.querySelectorAll('.excited-state-card');
                states.forEach((state, index) => {
                    state.querySelector('.state-number').textContent = index + 1;
                });
                projStateCount = states.length + 1; // +1 for ground state
            }
            
            // Add event listener for projectile excited states number input
            document.getElementById('proj-excited').addEventListener('change', function() {
                const numStates = parseInt(this.value);
                
                // Make sure there's at least 1 state (ground state)
                if (numStates < 1) {
                    this.value = 1;
                    return;
                }
                
                // If we need to add more states
                while (projStateCount < numStates) {
                    addProjectileState();
                }
                
                // If we need to remove states
                if (projStateCount > numStates) {
                    const states = additionalProjStates.querySelectorAll('.excited-state-card');
                    for (let i = numStates - 1; i < states.length; i++) {
                        states[i].remove();
                    }
                    projStateCount = numStates;
                    updateProjStateNumbers();
                }
                
                // Update iblock value
                updateIblockValue();
            });
            
            // Add state button listener
            addProjStateBtn.addEventListener('click', function() {
                addProjectileState();
            });
            
            // Update iblock value based on total number of states
            function updateIblockValue() {
                // For inelastic calculations, iblock should be total number of states
                const totalStates = targetStateCount + projStateCount - 1; // -1 because we only need to count one ground state
                document.getElementById('iblock').value = totalStates;
            }
            
            // Initialize with the correct number of excited states
            const targetExcitedInput = document.getElementById('targ-excited');
            const projExcitedInput = document.getElementById('proj-excited');
            
            // Set up initial states based on input values
            for (let i = 1; i < parseInt(targetExcitedInput.value); i++) {
                addTargetState();
            }
            
            for (let i = 1; i < parseInt(projExcitedInput.value); i++) {
                addProjectileState();
            }
            
            // Generate FRESCO input file
            document.getElementById('generate-btn').addEventListener('click', function() {
                generateInputFile();
            });

            // Copy to clipboard
            document.getElementById('copy-btn').addEventListener('click', function() {
                copyToClipboard();
            });

            // Download file
            document.getElementById('download-btn').addEventListener('click', function() {
                downloadInputFile();
            });
            
            // Generate input file function
            function generateInputFile() {
                // Get form values
                const header = document.getElementById('header').value || 'alpha+C12 inelastic scattering';
                const hcm = document.getElementById('hcm').value;
                const rmatch = document.getElementById('rmatch').value;
                const rintp = document.getElementById('rintp').value;
                const jtmax = document.getElementById('jtmax').value;
                const absend = document.getElementById('absend').value;
                const thmax = document.getElementById('thmax').value;
                const thinc = document.getElementById('thinc').value;
                const elab = document.getElementById('elab').value;
                const iter = document.getElementById('iter').value;
                const iblock = document.getElementById('iblock').value;
                
                const projectile = document.getElementById('projectile').value;
                const projMass = document.getElementById('proj-mass').value;
                const projZ = document.getElementById('proj-z').value;
                const projExcited = document.getElementById('proj-excited').value;
                
                const target = document.getElementById('target').value;
                const targMass = document.getElementById('targ-mass').value;
                const targZ = document.getElementById('targ-z').value;
                const targExcited = document.getElementById('targ-excited').value;
                
                const rc = document.getElementById('rc').value;
                const ap = document.getElementById('ap').value;
                const at = document.getElementById('at').value;
                
                const defType = document.getElementById('def-type').value;
                const defShape = document.getElementById('def-shape').value;
                const beta2 = document.getElementById('beta2').value;
                const beta3 = document.getElementById('beta3').value;
                
                // Collect all form data including basic and advanced parameters
                const formData = {
                    hcm: parseFloat(hcm),
                    rmatch: parseFloat(rmatch),
                    jtmin: 0.0,
                    jtmax: parseFloat(jtmax),
                    absend: parseFloat(absend),
                    thmin: 0.0,
                    thmax: parseFloat(thmax),
                    thinc: parseFloat(thinc),
                    chans: 1,
                    smats: 2,
                    xstabl: 1,
                    elab: elab,
                    iter: parseInt(iter),
                    iblock: parseInt(iblock)
                };
                
                // Add rintp only if it has a value
                if (rintp && rintp.trim() !== '') {
                    formData.rintp = parseFloat(rintp);
                }
                
                // Collect additional namelist parameters from advanced sections
                const namelistForms = document.getElementById('namelist-forms');
                if (namelistForms) {
                    const inputs = namelistForms.querySelectorAll('input, select');
                    inputs.forEach(input => {
                        const name = input.name;
                        const value = input.value;
                        if (name && value !== '' && value !== null && value !== undefined) {
                            if (input.type === 'number') {
                                formData[name] = parseFloat(value);
                            } else if (input.type === 'select-one' && input.selectedOptions[0]) {
                                const selectedValue = input.selectedOptions[0].value;
                                if (selectedValue === 'true') formData[name] = true;
                                else if (selectedValue === 'false') formData[name] = false;
                                else formData[name] = selectedValue;
                            } else {
                                formData[name] = value;
                            }
                        }
                    });
                }
                
                // Include parsed parameters from uploaded files
                if (window.parsedFrescoParameters) {
                    Object.keys(window.parsedFrescoParameters).forEach(param => {
                        let value = window.parsedFrescoParameters[param];
                        
                        // Special handling for elab - always use parsed value if it contains multiple energies
                        if (param === 'elab' && typeof value === 'string' && value.includes(',')) {
                            formData[param] = value;
                            console.log(`Overriding elab with parsed values: ${value}`);
                        } else if (!formData.hasOwnProperty(param)) {
                            // Only add if not already in formData (form fields take precedence)
                            // Try to parse as number if it looks like a number
                            if (typeof value === 'string' && /^-?\d*\.?\d+([eE][+-]?\d+)?$/.test(value)) {
                                value = parseFloat(value);
                            }
                            formData[param] = value;
                            console.log(`Including parsed parameter: ${param} = ${value}`);
                        }
                    });
                }
                
                // Generate namelist using the configuration
                const namelistSection = window.FrescoNamelist.generateNamelistSection(formData);
                
                // Build the input file content
                let inputContent = `${header}
NAMELIST
${namelistSection}

 &PARTITION namep='${projectile}' massp=${projMass} zp=${projZ} 
 	    namet='${target}' masst=${targMass} zt=${targZ} qval=0.0 nex=${targExcited} pwf=T /`;

                // Get target excited states
                const targStateSpins = document.querySelectorAll('.targ-state-spin');
                const targStateParities = document.querySelectorAll('.targ-state-parity');
                const targStateEnergies = document.querySelectorAll('.targ-state-energy');
                
                // Add ground state
                const groundStateSpin = targStateSpins[0].value;
                const groundStateParity = targStateParities[0].value > 0 ? '+' : '-';
                const groundStateEnergy = targStateEnergies[0].value;
                
                inputContent += `
 &STATES jp=0.0 copyp=0 bandp=1 ep=0.0000 kkp=0 tp=0 cpot=1 jt=${groundStateSpin} copyt=0 bandt=${groundStateParity}1 et=${groundStateEnergy} kkt=0 tt=0 /`;
                
                // Add excited states
                for (let i = 1; i < targStateSpins.length; i++) {
                    const spin = targStateSpins[i].value;
                    const parity = targStateParities[i].value > 0 ? '+' : '-';
                    const energy = targStateEnergies[i].value;
                    
                    inputContent += `
 &STATES jp=0.0 copyp=1 bandp=1 ep=0.0000 kkp=0 tp=0 cpot=1 jt=${spin} copyt=0 bandt=${parity}1 et=${energy} kkt=0 tt=0 /`;
                }
                
                inputContent += `
 &partition /
 
 &POT kp=1 ap=${ap} at=${at} rc=${rc}  /`;

                // Add nuclear potentials
                const potentials = potentialContainer.querySelectorAll('.potential-card');
                potentials.forEach(potential => {
                    const potType = potential.querySelector('.potential-type').value;
                    const potShape = potential.querySelector('.potential-shape').value;
                    const itValue = potential.querySelector('.it-field').value;
                    const p0 = potential.querySelector('.p0').value;
                    const p1 = potential.querySelector('.p1').value;
                    const p2 = potential.querySelector('.p2').value;
                    const p3 = potential.querySelector('.p3').value;
                    const p4 = potential.querySelector('.p4').value;
                    const p5 = potential.querySelector('.p5').value;
                    const p6 = potential.querySelector('.p6').value;
                    const p7 = potential.querySelector('.p7').value;
                    
                    let potLine = ` &POT kp=1 type=${potType} shape=${potShape} it=${itValue}`;
                    
                    // Add non-zero parameters
                    if (parseFloat(p0) !== 0) potLine += ` p0=${p0}`;
                    potLine += ` p1=${p1} p2=${p2} p3=${p3} p4=${p4} p5=${p5} p6=${p6}`;
                    if (parseFloat(p7) !== 0) potLine += ` p7=${p7}`;
                    potLine += `  /`;
                    
                    inputContent += `
${potLine}`;
                });
                
                // Add deformation potential
                inputContent += `
 &POT kp=1 type=${defType} shape=${defShape}  /
   &step ib=2 ia=1 k=2 str=${beta2}  /
   &step ib=1 ia=2 k=2 str=${beta2}  /`;
                
                // Add beta3 if non-zero
                if (parseFloat(beta3) !== 0) {
                    inputContent += `
   &step ib=2 ia=1 k=3 str=${beta3}  /
   &step ib=1 ia=2 k=3 str=${beta3}  /`;
                }

                // End input file
                inputContent += `
 &pot / 
 &overlap / 
 &coupling / 



`; // Added multiple empty lines for FRESCO stdin reading

                // Update output area
                document.getElementById('output').textContent = inputContent;
            }
            
            // Copy to clipboard function
            function copyToClipboard() {
                const outputText = document.getElementById('output').textContent;
                navigator.clipboard.writeText(outputText).then(
                    function() {
                        // Success message
                        const copyBtn = document.getElementById('copy-btn');
                        const originalText = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
                        
                        setTimeout(function() {
                            copyBtn.innerHTML = originalText;
                        }, 2000);
                    },
                    function() {
                        alert('Failed to copy to clipboard');
                    }
                );
            }
            
            // Download input file function
            function downloadInputFile() {
                const outputText = document.getElementById('output').textContent;
                const projectile = document.getElementById('projectile').value;
                const target = document.getElementById('target').value;
                const fileName = `${projectile}_${target}_inelastic.in`;
                
                const blob = new Blob([outputText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                setTimeout(function() {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 0);
            }
            
            // Add first target excited state by default
            if (targetStateCount === 1) {
                addTargetState();
            }
            
            // Update iblock initially
            updateIblockValue();
        });
    </script>
</body>
</html>